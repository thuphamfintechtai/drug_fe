name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history ƒë·ªÉ Vercel c√≥ th·ªÉ x√°c ƒë·ªãnh commit author
          fetch-depth: 0
          # S·ª≠ d·ª•ng token ƒë·ªÉ c√≥ quy·ªÅn ƒë·ªçc commit author
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git v·ªõi t√†i kho·∫£n GitHub
        run: |
          # Set git config v·ªõi th√¥ng tin t√†i kho·∫£n m·∫∑c ƒë·ªãnh
          # Email: thupham@fintechai.vn
          # Username: thuphamfintechai
          git config --global user.name "thuphamfintechai"
          git config --global user.email "thupham@fintechai.vn"
          
          # Hi·ªÉn th·ªã th√¥ng tin ƒë√£ set
          echo "‚úÖ Git user: $(git config --global user.name)"
          echo "‚úÖ Git email: $(git config --global user.email)"
          
          # Export ƒë·ªÉ s·ª≠ d·ª•ng ·ªü c√°c steps sau
          echo "GIT_USER_NAME=thuphamfintechai" >> $GITHUB_ENV
          echo "GIT_USER_EMAIL=thupham@fintechai.vn" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Configure Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Set Vercel environment variables
          echo "VERCEL_ORG_ID=$VERCEL_ORG_ID" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID" >> $GITHUB_ENV
          
          # Link project v·ªõi team (n·∫øu ch∆∞a link)
          vercel link --yes --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --project "$VERCEL_PROJECT_ID" || true

      - name: Pull Vercel environment info
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

      - name: Build project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          vercel build --prod --token "$VERCEL_TOKEN"

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Deploy v·ªõi VERCEL_TOKEN
          # Quan tr·ªçng: VERCEL_TOKEN ph·∫£i ƒë∆∞·ª£c t·∫°o t·ª´ account owner c·ªßa team "ZuZu's projects"
          echo "üöÄ Deploying to Vercel..."
          vercel deploy --prebuilt --prod --token "$VERCEL_TOKEN" --yes
